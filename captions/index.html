<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Image Captioner V2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* ---- Layout --------------------------------------------------- */
      body {
        background: #f8f9fa;
        min-height: 100vh; /* let the footer hug the bottom */
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1; /* grow / shrink so footer stays at bottom */
      }

      /* ---- Drop‑zone styling --------------------------------------- */
      #dropzone {
        border: 2px dashed #6c757d;
        border-radius: 0.5rem;
        padding: 3rem;
        text-align: center;
        background: #fff;
        transition: background 0.2s, border-color 0.2s;
        cursor: pointer;
      }
      #dropzone.dragover {
        background: #e9f3ff;
        border-color: #0d6efd;
      }

      /* ---- Thumbnail ----------------------------------------------- */
      img.thumb {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 0.25rem;
      }
    </style>
  </head>
  <body>
    <!-- ================== Header ================== -->
    <header
      class="bg-light border-bottom shadow-sm px-3 py-2 d-flex justify-content-between align-items-center"
    >
      <span class="fw-semibold fs-5">Image Captioner V2</span>

      <div class="d-flex align-items-center gap-2">
        <!-- API‑key field -->
        <div class="input-group input-group-sm" style="max-width: 260px">
          <span class="input-group-text"><i class="bi bi-key"></i></span>
          <input
            id="apiKey"
            type="password"
            class="form-control"
            placeholder="OpenAI API key"
          />
          <button
            id="toggleKeyVis"
            class="btn btn-outline-secondary"
            title="Show / hide key"
          >
            <i class="bi bi-eye"></i>
          </button>
          <button
            id="clearKeyBtn"
            class="btn btn-outline-danger"
            title="Clear key"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <span id="globalStatus" class="small text-muted">Ready</span>
      </div>
    </header>

    <!-- ================== Main ================== -->
    <main class="container my-4">
      <!-- Prompt textarea -->
      <div class="mb-3">
        <label for="prompt" class="form-label fw-semibold"
          >Caption prompt
          <span class="text-muted fst-italic small">(auto‑saved)</span></label
        >
        <textarea id="prompt" class="form-control" rows="4"></textarea>
      </div>

      <!-- Drop zone -->
      <div id="dropzone" class="mb-4">
        <p class="lead text-muted mb-0">
          <i class="bi bi-cloud-arrow-up fs-3"></i><br />Drag &amp; drop images here
          or click to select
        </p>
        <input id="fileInput" type="file" accept="image/*" multiple hidden />
      </div>

      <!-- Table actions -->
      <div class="mb-3">
        <button id="clearTableBtn" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-trash"></i> Clear Table
        </button>
      </div>

      <!-- Results table -->
      <div class="table-responsive">
        <table id="resultsTbl" class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Image</th>
              <th style="width: 70%">Caption / Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>

    <!-- ================== Footer (mirrors header) ================== -->
    <footer
      class="bg-light border-top shadow-sm px-3 py-2 text-center small text-muted mt-auto"
    >
      © 2025 <span id="authorName">Chris Merrill</span>
    </footer>

    <!-- Toast for missing key -->
    <div
      class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3"
    >
      <div
        id="noKeyToast"
        class="toast text-bg-warning border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            Enter your OpenAI API key to enable uploading.
          </div>
          <button
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /******************** Constants *********************/
      const LS_KEY = 'openai_key_v2';
      const LS_PROMPT = 'caption_prompt_v2';
      const DEFAULT_PROMPT =
        "Please caption this image in under 1024 characters. The caption must begin by identifying the type of image (e.g., 'An illustration' or 'A digital illustration'). It should clearly and concisely describe only the visual elements, using neutral and literal language. Avoid emotional, subjective, or interpretive terms. Focus on what is visibly present, with concise and direct descriptions.";

      /******************** DOM refs *********************/
      const apiKeyEl = document.getElementById('apiKey');
      const toggleKeyVisBtn = document.getElementById('toggleKeyVis');
      const clearKeyBtn = document.getElementById('clearKeyBtn');
      const promptEl = document.getElementById('prompt');
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const clearTableBtn = document.getElementById('clearTableBtn');
      const tblBody = document.querySelector('#resultsTbl tbody');
      const globalStatus = document.getElementById('globalStatus');
      const noKeyToast = new bootstrap.Toast(document.getElementById('noKeyToast'), {
        delay: 5000,
      });

      /******************** State *********************/
      let totalCount = 0; // total images in current batch
      let finishedCount = 0;

      /******************** Helpers *********************/
      function setGlobalStatus(text, spinner = false) {
        globalStatus.innerHTML = spinner
          ? `<span class="spinner-border spinner-border-sm me-1" role="status"></span>${text}`
          : text;
      }

      const saveKey = () => localStorage.setItem(LS_KEY, apiKeyEl.value.trim());
      const savePrompt = () => localStorage.setItem(LS_PROMPT, promptEl.value);
      const getKey = () => apiKeyEl.value.trim();

      function applyKeyState() {
        const hasKey = !!getKey();
        dropzone.classList.toggle('d-none', !hasKey);
        promptEl.disabled = !hasKey;
        if (!hasKey) {
          noKeyToast.show();
        } else {
          noKeyToast.hide();
        }
      }

      function loadPrefs() {
        apiKeyEl.value = localStorage.getItem(LS_KEY) || '';
        promptEl.value = localStorage.getItem(LS_PROMPT) ?? DEFAULT_PROMPT;
        applyKeyState();
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      const statusHTML = (label) =>
        `<span class="spinner-border spinner-border-sm me-1"></span>${label}`;

      function addTableRow(index, file) {
        const url = URL.createObjectURL(file);
        const tr = tblBody.insertRow();
        tr.innerHTML = `<th>${index}</th>
                 <td><img src="${url}" class="thumb" alt="thumb"></td>
                 <td>${statusHTML('Queued…')}</td>`;
        return tr.cells[2];
      }

      async function callOpenAIWithStatus(file, rowCell) {
        // Step 1: encode
        rowCell.innerHTML = statusHTML('Encoding image…');
        const image_b64 = await fileToBase64(file);

        // Step 2: request sent
        rowCell.innerHTML = statusHTML('Request sent…');
        const body = {
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'user',
              content: [
                { type: 'text', text: promptEl.value },
                {
                  type: 'image_url',
                  image_url: { url: `data:${file.type};base64,${image_b64}` },
                },
              ],
            },
          ],
        };
        const headers = {
          Authorization: `Bearer ${getKey()}`,
          'Content-Type': 'application/json',
        };
        const resPromise = fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers,
          body: JSON.stringify(body),
        });

        // Step 3: waiting
        rowCell.innerHTML = statusHTML('Waiting for response…');
        const res = await resPromise;
        if (!res.ok) throw new Error(`OpenAI error ${res.status}`);

        // Step 4: parsing
        rowCell.innerHTML = statusHTML('Processing response…');
        const data = await res.json();
        return data.choices?.[0]?.message?.content || '[No caption]';
      }

      async function processImage(file, rowCell) {
        try {
          const caption = await callOpenAIWithStatus(file, rowCell);
          rowCell.textContent = caption;
        } catch (err) {
          rowCell.textContent = `❌ ${err.message}`;
        }
        finishedCount++;
        if (finishedCount === totalCount) {
          promptEl.disabled = false;
          setGlobalStatus('Ready');
        } else {
          setGlobalStatus(`Processing ${finishedCount} / ${totalCount}…`, true);
        }
      }

      /******************** Event wiring *********************/
      // Save / load cycle
      apiKeyEl.addEventListener('input', () => {
        saveKey();
        applyKeyState();
      });
      toggleKeyVisBtn.addEventListener('click', () => {
        const isPassword = apiKeyEl.type === 'password';
        apiKeyEl.type = isPassword ? 'text' : 'password';
        toggleKeyVisBtn.innerHTML = isPassword
          ? '<i class="bi bi-eye-slash"></i>'
          : '<i class="bi bi-eye"></i>';
      });
      clearKeyBtn.addEventListener('click', () => {
        apiKeyEl.value = '';
        saveKey();
        applyKeyState();
      });
      promptEl.addEventListener('input', savePrompt);

      // Drop zone interactions
      dropzone.addEventListener('click', () => fileInput.click());
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      fileInput.addEventListener('change', () => handleFiles(fileInput.files));

      function handleFiles(fileList) {
        if (!getKey()) return applyKeyState();
        const files = Array.from(fileList).filter((f) => f.type.startsWith('image/'));
        if (!files.length) return;

        totalCount = files.length;
        finishedCount = 0;
        promptEl.disabled = true;
        setGlobalStatus(`Processing 0 / ${totalCount}…`, true);

        files.forEach((file, idx) => {
