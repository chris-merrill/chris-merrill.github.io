<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>eBay Photo Capture</title>
  <!-- Bootstrap & jQuery via CDN  -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    #preview { background:#000; aspect-ratio:16/9; object-fit:cover; }
    #shotFlash {
      position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none;
      transition:opacity .2s ease-in-out;
    }
    #shotFlash.show { opacity:.8; transition-duration:.1s; }
    .thumb   { height:72px; width:auto; }
  </style>
</head>
<body>
  <div id="shotFlash"></div>
  <div class="container py-4">
    <h1 class="h3 mb-4 text-center">Quick eBay Photo Capture</h1>

    <!-- Camera selector -->
    <div class="mb-3 row align-items-center">
      <label for="cameraSelect" class="col-sm-2 col-form-label">Camera</label>
      <div class="col-sm-10">
        <select id="cameraSelect" class="form-select"></select>
      </div>
    </div>

    <!-- Live preview -->
    <video id="preview" class="border rounded w-100" autoplay playsinline muted></video>

    <!-- Capture button -->
    <div class="d-grid gap-2 col-6 mx-auto my-4">
      <button id="captureBtn" class="btn btn-primary btn-lg">
        <i class="bi bi-camera"></i> Capture &amp; Download
      </button>
    </div>

    <!-- Thumbnail gallery -->
    <div id="gallery" class="d-flex flex-wrap gap-2"></div>
  </div>

  <!-- Hidden canvas for processing the still -->
  <canvas id="hiddenCanvas" style="display:none;"></canvas>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap Icons (optional, small) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <script>
    (function() {
      const \$camSelect   = \$('#cameraSelect');
      const video        = \$('#preview')[0];
      const canvas       = \$('#hiddenCanvas')[0];
      const ctx          = canvas.getContext('2d');
      const flash        = \$('#shotFlash');
      const gallery      = \$('#gallery');
      let stream         = null;
      let currentDeviceId= null;

      // --- helpers ---------------------------------------------------------
      const fileName = () => 'ebay-' + new Date().toISOString().replace(/[:.]/g,'-') + '.jpg';
      const flashScreen = () => { flash.addClass('show'); setTimeout(()=>flash.removeClass('show'),150); };

      // --- camera init -----------------------------------------------------
      async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams    = devices.filter(d => d.kind === 'videoinput');
        $camSelect.empty();
        cams.forEach((cam,i) => {
          const label = cam.label || `Camera ${i+1}`;
          $('<option>').val(cam.deviceId).text(label).appendTo($camSelect);
        });
        if (cams.length) {
          currentDeviceId = cams[0].deviceId;
          await startCamera(currentDeviceId);
        }
      }

      async function startCamera(deviceId) {
        if (stream) stream.getTracks().forEach(t => t.stop());
        const constraints = {
          audio:false,
          video:{
            deviceId: { exact: deviceId },
            width:  { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };
        try {
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
        } catch(err) {
          alert('Unable to access camera: '+ err.message);
        }
      }

      // --- capture ---------------------------------------------------------
      function capture() {
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const w = settings.width  || video.videoWidth;  // fallback to element size
        const h = settings.height || video.videoHeight;

        canvas.width  = w;
        canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);

        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          autoDownload(url, fileName());
          addThumbnail(url);
        }, 'image/jpeg', 0.92);

        flashScreen();
      }

      function autoDownload(url, name) {
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function addThumbnail(url) {
        const img = $('<img>').attr('src', url).addClass('thumb rounded border');
        gallery.prepend(img);
      }

      // --- event wiring ----------------------------------------------------
      $(document).ready(async () => {
        if (!navigator.mediaDevices?.getUserMedia) {
          alert('getUserMedia not supported in this browser.');
          return;
        }
        await listCameras();
      });

      $camSelect.on('change', async function() {
        currentDeviceId = this.value;
        await startCamera(currentDeviceId);
      });

      \$('#captureBtn').on('click', capture);
      // Space‑bar shortcut when button is focused or body
      $(document).on('keydown', e => {
        if (e.code === 'Space' && !e.repeat) {
          e.preventDefault(); capture();
        }
      });

      // Re‑populate camera list if new hardware is plugged in
      navigator.mediaDevices.addEventListener('devicechange', listCameras);

    })();
  </script>
</body>
</html>
